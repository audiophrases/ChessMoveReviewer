<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Chess Reviewer</title>

  <!-- Tailwind Play CDN (warning in console is harmless) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" crossorigin="anonymous">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #1a1a1a; color: #e0e0e0; }
    .chessboard-container { width: 100%; margin: 0 auto; aspect-ratio: 1 / 1; }
    .move-item { transition: background-color: 0.2s ease-in-out; border-radius: 0.5rem; }
    .move-item.highlight { background-color: #384a6e; }
    .move-item:hover { background-color: #2c3a57; }
    #move-analysis-container::-webkit-scrollbar { width: 8px; }
    #move-analysis-container::-webkit-scrollbar-track { background: #2a2a2a; }
    #move-analysis-container::-webkit-scrollbar-thumb { background-color: #4a4a4a; border-radius: 10px; border: 2px solid #2a2a2a; }
    .btn-primary { background-color: #4a90e2; transition: background-color 0.3s; }
    .btn-primary:hover { background-color: #357abd; }
    .btn-primary:disabled { background-color: #374151; cursor: not-allowed; }
    .btn-secondary { background-color: #4a4a4a; transition: background-color: 0.3s; }
    .btn-secondary:hover { background-color: #5a5a5a; }
    textarea.form-input { background-color: #252526; border-color: #4a4a4a; }
    textarea.form-input:focus { border-color: #4a90e2; box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.5); outline: none; }
    .step-indicator { background-color: #374151; }
    .step-indicator.active { background-color: #4a90e2; }
  </style>
</head>
<body class="min-h-screen flex flex-col p-4 md:p-6">

  <header class="text-center mb-6">
    <h1 class="text-3xl md:text-4xl font-bold text-white">AI Chess Reviewer</h1>
    <p class="text-gray-400 mt-2">A new way to get deep, AI-powered analysis of your games.</p>
  </header>

  <!-- Step Indicators -->
  <div class="flex justify-center items-center space-x-4 mb-8">
    <div id="indicator-1" class="step-indicator active w-8 h-2 rounded-full"></div>
    <div id="indicator-2" class="step-indicator w-8 h-2 rounded-full"></div>
    <div id="indicator-3" class="step-indicator w-8 h-2 rounded-full"></div>
  </div>

  <!-- Step 1: PGN Input -->
  <div id="step1-section" class="max-w-2xl w-full mx-auto flex flex-col gap-4">
    <h2 class="text-2xl font-bold text-center">Step 1: Analyze PGN with Stockfish</h2>
    <p class="text-center text-gray-400">Paste your game's PGN below. The engine will run in your browser to add move evaluations.</p>
    <div>
      <label for="pgn-input" class="block mb-2 font-semibold text-gray-300">Paste PGN here</label>
      <textarea id="pgn-input" rows="12" class="w-full p-3 rounded-lg form-input" placeholder="[Event &quot;...&quot;]..."></textarea>
    </div>
    <button id="analyze-pgn-btn" class="w-full py-3 px-6 text-lg font-semibold text-white rounded-lg btn-primary" disabled>
      Loading Engine...
    </button>
  </div>

  <!-- Step 2: Stockfish Output & AI Instructions -->
  <div id="step2-section" class="hidden max-w-2xl w-full mx-auto flex flex-col gap-4">
    <h2 class="text-2xl font-bold text-center">Step 2: Get AI Coaching Comments</h2>
    <div id="stockfish-progress" class="text-center p-4 bg-[#252526] rounded-lg">
      <p id="progress-text" class="text-lg text-yellow-400">Initializing Stockfish...</p>
      <div class="w-full bg-gray-600 rounded-full h-2.5 mt-2">
        <div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
      </div>
    </div>
    <div>
      <label for="stockfish-output" class="block mb-2 font-semibold text-gray-300">1. Copy the prompt + annotated PGN below</label>
      <textarea id="stockfish-output" rows="14" class="w-full p-3 rounded-lg form-input" readonly></textarea>
      <button id="copy-stockfish-btn" class="w-full mt-2 py-2 px-4 font-semibold text-white rounded-lg btn-secondary">Copy to Clipboard</button>
    </div>
    <div class="p-4 bg-green-900/50 border border-green-700 rounded-lg">
      <h3 class="font-semibold text-green-300">2. What this button copies</h3>
      <p class="text-sm text-green-300/80 mt-1">
        The button above copies the following instruction block and your annotated PGN together, ready to paste into an AI.
      </p>
      <div class="mt-2 p-2 bg-black/30 rounded">
        <p class="text-xs text-gray-300 whitespace-pre-wrap font-mono">
Analyze the following PGN, which includes Stockfish evaluations in braces {}. For each move, provide a textual analysis on a new line. Format each line exactly as:

move - classification: comment

For the classification, use one word (e.g., Book, Good, Brilliant, Inaccuracy, Mistake, Blunder, Forced). Do not add any move numbers, markdown, or other formatting to your response.
        </p>
      </div>
    </div>
    <button id="goto-step3-btn" class="w-full py-3 px-6 text-lg font-semibold text-white rounded-lg btn-primary" disabled>
      Continue to Final Step
    </button>
  </div>

  <!-- Step 3: Final Analysis Input -->
  <div id="step3-section" class="hidden max-w-2xl w-full mx-auto flex flex-col gap-4">
    <h2 class="text-2xl font-bold text-center">Step 3: Paste Your Final AI Review</h2>
    <p class="text-center text-gray-400">Paste the full text from the AI, including the PGN and the new coaching comments.</p>
    <div>
      <label for="final-analysis-input" class="block mb-2 font-semibold text-gray-300">Paste complete analysis here</label>
      <textarea id="final-analysis-input" rows="12" class="w-full p-3 rounded-lg form-input" placeholder="e4 - Good: A classical opening move..."></textarea>
    </div>
    <button id="generate-review-btn" class="w-full py-3 px-6 text-lg font-semibold text-white rounded-lg btn-primary">
      Generate Interactive Review
    </button>
  </div>

  <!-- Final Review Section -->
  <main id="review-section" class="hidden flex-1 max-w-7xl w-full mx-auto grid grid-cols-1 lg:grid-cols-5 gap-6">
    <div class="lg:col-span-2 flex flex-col items-center">
      <div class="w-full max-w-md mx-auto">
        <div id="board" class="chessboard-container"></div>
      </div>
      <div id="controls" class="mt-4 flex flex-wrap items-center justify-center gap-2 w-full">
        <button id="prev-btn" class="px-4 py-2 text-white font-semibold rounded-lg btn-secondary">‹ Prev</button>
        <button id="next-btn" class="px-4 py-2 text-white font-semibold rounded-lg btn-secondary">Next ›</button>
        <button id="flip-btn" class="px-4 py-2 text-white font-semibold rounded-lg btn-secondary">Flip</button>
      </div>
      <button id="start-new-btn" class="mt-4 w-full max-w-xs py-2 px-4 text-white font-semibold rounded-lg btn-primary">
        Analyze Another Game
      </button>
    </div>
    <div class="lg:col-span-3 bg-[#252526] p-4 rounded-lg flex flex-col h-96 lg:h-auto lg:max-h-[calc(100vh-5rem)]">
      <h2 class="text-xl font-bold border-b border-gray-600 pb-2 mb-3 flex-shrink-0">Game Analysis</h2>
      <div id="move-analysis-container" class="overflow-y-auto flex-1 pr-2 space-y-1"></div>
    </div>
  </main>

  <!-- Error Modal -->
  <div id="error-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
    <div class="bg-[#2d2d2d] p-8 rounded-lg shadow-xl max-w-sm w-full text-center">
      <h3 class="text-2xl font-bold text-red-400 mb-4">Error</h3>
      <p id="error-message" class="text-gray-300 mb-6">Could not process the input.</p>
      <button id="close-modal-btn" class="py-2 px-6 font-semibold text-white rounded-lg btn-primary">Close</button>
    </div>
  </div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>

<script>
  $(function () {
    // ====== Stockfish (same-origin Worker) ======
    const LOCAL_ENGINE = 'engine/stockfish-nnue-16-single.js';
    let engineWorker = new Worker(LOCAL_ENGINE);
    let engineReady = false;
    let lastInfoMsg = '';
    let currentScoreResolver = null;

    // Exact instruction block that gets prepended to the PGN for copying
    var ANALYSIS_PROMPT =
      'Analyze the following PGN, which includes Stockfish evaluations in braces {}. For each move, provide a textual analysis on a new line. Format each line exactly as:\\n\\n' +
      'move - classification: comment\\n\\n' +
      'For the classification, use one word (e.g., Book, Good, Brilliant, Inaccuracy, Mistake, Blunder, Forced). Do not add any move numbers, markdown, or other formatting to your response.';

    engineWorker.onmessage = function(e) {
      var msg = String(e.data || '');
      if (msg.startsWith('id name')) {
        engineReady = true;
        $('#analyze-pgn-btn').prop('disabled', false).text('Run Stockfish Analysis');
      } else if (msg.startsWith('info depth')) {
        lastInfoMsg = msg;
      } else if (msg.startsWith('bestmove')) {
        var cp = /score cp (-?\\d+)/.exec(lastInfoMsg);
        var mt = /score mate (-?\\d+)/.exec(lastInfoMsg);
        if (currentScoreResolver) {
          if (mt) currentScoreResolver('#' + mt[1]);
          else if (cp) {
            var s = (parseInt(cp[1], 10) / 100).toFixed(2);
            currentScoreResolver(parseFloat(s) > 0 ? '+' + s : s);
          } else currentScoreResolver('0.00');
          currentScoreResolver = null;
        }
      }
    };
    engineWorker.postMessage('uci');

    // ====== App state ======
    var board = null;
    var game = new Chess();
    var movesWithAnalysis = [];
    var currentMoveIndex = -1;

    var classificationStyles = {
      'book': 'text-blue-400','good':'text-green-400','okay':'text-green-400','excellent':'text-teal-400','great':'text-teal-400',
      'brilliant':'text-cyan-300','inaccuracy':'text-yellow-400','mistake':'text-orange-400','blunder':'text-red-500','forced':'text-gray-400','default':'text-gray-400'
    };
    function getStyleForClassification(c) { return classificationStyles[(c || '').toLowerCase().replace(/\\s/g,'')] || classificationStyles['default']; }
    function formatText(t) { return t ? String(t).replace(/\\*\\*(.*?)\\*\\*/g,'<strong>$1</strong>') : ''; }
    function showError(m) { $('#error-message').text(m); $('#error-modal').removeClass('hidden'); }
    $('#close-modal-btn').on('click', function(){ $('#error-modal').addClass('hidden'); });

    // ---------- New: robust PGN normalization ----------
    function normalizePgn(raw, opts) {
      opts = opts || {};
      var keepComments = !!opts.keepComments; // for step 3 we still want clean, so false is fine

      // Normalize newlines + strip BOM + trim
      var s = String(raw || '')
        .replace(/\\r\\n?/g, '\\n')
        .replace(/^\\uFEFF/, '')
        .trim();

      if (!s) return '';

      // Split into lines
      var lines = s.split('\\n');

      // Extract headers at the top (any consecutive lines that look like [Tag "Value"])
      var headerLines = [];
      var i = 0;
      while (i < lines.length && /^\\s*\\[.*\\]\\s*$/.test(lines[i])) {
        headerLines.push(lines[i].trim());
        i++;
      }

      // The rest is move text (may include blank first line)
      var movePart = lines.slice(i).join('\\n');

      // If there were NO headers at top, try to salvage headers that might appear later (some exports do odd ordering)
      if (headerLines.length === 0) {
        var allLines = s.split('\\n');
        var lastHeaderIdx = -1;
        for (var j = 0; j < allLines.length; j++) {
          if (/^\\s*\\[.*\\]\\s*$/.test(allLines[j])) lastHeaderIdx = j;
        }
        if (lastHeaderIdx >= 0) {
          headerLines = allLines.slice(0, lastHeaderIdx + 1).map(function(x){ return x.trim(); });
          movePart = allLines.slice(lastHeaderIdx + 1).join('\\n');
        }
      }

      // Strip comments and noise from move part unless specifically told to keep them
      if (!keepComments) {
        // Remove {...} comments (includes Lichess clock like { [%clk ...] } and any other brace comments)
        movePart = movePart.replace(/\\{[^}]*\\}/g, ' ');

        // Remove (...) side-variations (RAVs)
        // (simple, non-nested removal; good enough for most PGNs)
        movePart = movePart.replace(/\\([^()]*\\)/g, ' ');

        // Remove NAGs like $1, $2, etc.
        movePart = movePart.replace(/\\$\\d+/g, ' ');

        // Remove move suffix punctuation !, ?, !!, ??, !?, ?!
        movePart = movePart.replace(/([a-hRNBQKO0-9=:+#-])([!?]{1,2})/g, '$1');

        // Normalize ellipsis char to ASCII
        movePart = movePart.replace(/\\u2026/g, '...');

        // Sometimes exporters jam results mid-line; that's ok.
      }

      // Collapse whitespace, but preserve essential spacing around dots and results
      movePart = movePart
        .replace(/\\s+/g, ' ')
        .replace(/\\s*\\.(\\.\\.)?\\s*/g, function(m){ return m.trim() + ' '; }) // keep "1." and "1..." tidy
        .trim();

      // Rebuild PGN
      var headerBlock = headerLines.length ? headerLines.join('\\n') : '';
      return headerBlock ? (headerBlock + '\\n\\n' + movePart) : movePart;
    }
    // ---------------------------------------------------

    function switchStep(step) {
      ['#step1-section','#step2-section','#step3-section','#review-section'].forEach(function(s){ $(s).addClass('hidden'); });
      $('.step-indicator').removeClass('active');
      $('#indicator-' + step).addClass('active');
      if (step <= 3) $('#step' + step + '-section').removeClass('hidden');
      else $('#review-section').removeClass('hidden').addClass('grid');
    }

    $('#analyze-pgn-btn').on('click', function () {
      if (!engineReady) { showError('Engine still initializing. Try again in a second.'); return; }
      var pgnRaw = $('#pgn-input').val().trim();
      if (!pgnRaw) { showError('Please paste a PGN.'); return; }

      // New: normalize before loading
      var pgn = normalizePgn(pgnRaw /* keepComments: false */);

      if (!game.load_pgn(pgn)) {
        // One more try: sometimes headers confuse very exotic exports; try moves only
        var justMoves = normalizePgn(pgnRaw.replace(/^(\\s*\\[.*\\]\\s*$)+/gm, ''), { });
        if (!game.load_pgn(justMoves)) {
          showError('Invalid PGN format. Try removing engine/clock comments or share the PGN example with me.');
          return;
        }
      }

      switchStep(2);
      runStockfishAnalysis();
    });

    async function runStockfishAnalysis() {
      var sanMoves = game.history();
      var annotatedPgn = game.header() ? game.pgn({ maxWidth: 9999 }).split('\\n\\n')[0] + '\\n\\n' : '';
      var temp = new Chess();

      for (var i = 0; i < sanMoves.length; i++) {
        var moveNumber = Math.floor(i / 2) + 1;
        var prefix = (i % 2 === 0) ? (moveNumber + '. ') : (moveNumber + '... ');
        var move = sanMoves[i];

        temp.move(move);

        $('#progress-text').text('Analyzing move ' + (i + 1) + '/' + sanMoves.length + ': ' + move);
        $('#progress-bar').css('width', (((i + 1) / sanMoves.length) * 100) + '%');

        var score = await getScore(temp.fen());
        annotatedPgn += (i % 2 === 0 ? prefix : '') + move + ' {' + score + '} ';
      }

      var combined = ANALYSIS_PROMPT + '\\n\\n' + annotatedPgn.trim();
      $('#progress-text').text('Analysis Complete!');
      $('#stockfish-output').val(combined);
      $('#goto-step3-btn').prop('disabled', false);
    }

    function getScore(fen) {
      return new Promise(function(resolve) {
        currentScoreResolver = resolve;
        lastInfoMsg = '';
        engineWorker.postMessage('position fen ' + fen);
        engineWorker.postMessage('go depth 15');
      });
    }

    $('#copy-stockfish-btn').on('click', function () {
      navigator.clipboard.writeText($('#stockfish-output').val()).then(function(){
        $('#copy-stockfish-btn').text('Copied!');
        setTimeout(function(){ $('#copy-stockfish-btn').text('Copy to Clipboard'); }, 2000);
      });
    });

    $('#goto-step3-btn').on('click', function(){ switchStep(3); });

    $('#generate-review-btn').on('click', function () {
      var finalAnalysisRaw = $('#final-analysis-input').val().trim();
      if (!finalAnalysisRaw) { showError('Please paste the final analysis.'); return; }

      // New: normalize again before sending to chess.js (strips comments/NAGs/variations)
      var pgn = normalizePgn(finalAnalysisRaw /* keepComments: false */);

      if (!game.load_pgn(pgn)) {
        showError('Could not find a valid PGN in the pasted text.');
        return;
      }

      switchStep(4);

      var gameMoves = game.history({ verbose: true });
      var parsed = parseAnalysis(finalAnalysisRaw); // keep original text for commentary parsing

      var cursor = 0;
      movesWithAnalysis = gameMoves.map(function(m) {
        var analysis = null;
        if (cursor < parsed.moves.length && parsed.moves[cursor].san === m.san) analysis = parsed.moves[cursor++];
        return { ...m, analysis: analysis, criticalMoment: parsed.criticalMoments[m.san] };
      });

      if (!board) {
        board = Chessboard('board', { position: 'start', draggable: false, pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' });
        $(window).on('resize', function(){ board.resize(); });
      }

      board.position('start');
      renderMoveList();
      renderSummary(parsed.summaries);
      goToMove(-1);
      board.resize();
    });

    function parseAnalysis(text) {
      var lines = text.split('\\n');
      var parsedMoves = [];
      var criticalMoments = {};
      var summaries = {};
      var currentSummary = null;
      var lastSan = null;

      var moveRegex = /^(?:\\d+\\.{1,3}\\s*)?([^\\s–—]+)\\s*[–-—]\\s*([^:]+):\\s*(.*)/;
      var criticalMomentRegex = /^Critical Moment:\\s*(.*)/i;
      var summaryHeaderRegex = /^\\s*\\*\\*(Strengths|Recurring Mistakes|Top 3 Takeaways)\\*\\*/i;

      lines.forEach(function(line) {
        var m = line.match(moveRegex);
        if (m) {
          var san = m[1];
          var classification = m[2].trim().replace(/\\*\\*/g,'');
          var txt = m[3].trim();
          parsedMoves.push({ san: san, classification: classification, text: txt });
          lastSan = san;
          currentSummary = null;
          return;
        }
        var cm = line.match(criticalMomentRegex);
        if (cm && lastSan) { criticalMoments[lastSan] = cm[1]; return; }
        var sh = line.match(summaryHeaderRegex);
        if (sh) { var key = sh[1].replace(/\\s/g,''); summaries[key] = []; currentSummary = key; return; }
        if (line.trim() && line.trim() !== '---' && currentSummary) summaries[currentSummary].push(line.trim());
      });

      return { moves: parsedMoves, criticalMoments: criticalMoments, summaries: summaries };
    }

    function renderMoveList() {
      var c = $('#move-analysis-container').empty();
      movesWithAnalysis.forEach(function(mv, i) {
        var n = mv.color === 'w' ? (Math.floor(i / 2) + 1) + '.' : '';
        var html =
          '<div class="move-item p-2 cursor-pointer" data-move-index="' + i + '">' +
            '<div class="flex items-baseline gap-3">' +
              '<span class="text-gray-500 font-mono w-8 text-right">' + n + '</span>' +
              '<span class="font-bold text-lg text-white">' + mv.san + '</span>' +
              (mv.analysis ? '<span class="font-semibold text-sm ' + getStyleForClassification(mv.analysis.classification) + '">' + mv.analysis.classification + '</span>' : '') +
            '</div>' +
            (mv.analysis ? '<p class="pl-12 text-gray-300 text-sm">' + formatText(mv.analysis.text) + '</p>' : '') +
            (mv.criticalMoment ? '<p class="pl-12 mt-1 text-sm text-yellow-300 bg-yellow-900 bg-opacity-40 p-2 rounded">' + formatText('**Critical Moment:** ' + mv.criticalMoment) + '</p>' : '') +
          '</div>';
        c.append(html);
      });
      $('.move-item').on('click', function(){ goToMove($(this).data('move-index')); });
    }

    function renderSummary(summaries) {
      var container = $('#move-analysis-container');
      var order = ['Strengths','RecurringMistakes','Top3Takeaways'];
      var titles = { Strengths: 'Strengths', RecurringMistakes: 'Recurring Mistakes', Top3Takeaways: 'Top 3 Takeaways' };
      var blocks = [];
      order.forEach(function(k) {
        var arr = summaries[k] || [];
        if (!arr.length) return;
        var html = '<h3 class="text-lg font-semibold mt-2 mb-1 text-gray-200">' + titles[k] + '</h3><ul class="list-disc list-inside space-y-1 text-sm text-gray-300">';
        arr.forEach(function(item){ html += '<li>' + formatText(item.replace(/^(\\*|-|\\d+\\.)\\s*/,'')) + '</li>'; });
        html += '</ul>';
        blocks.push(html);
      });
      if (blocks.length) container.append('<div class="mt-4 border-t border-gray-600 pt-3">' + blocks.join('') + '</div>');
    }

    function goToMove(idx) {
      if (idx < -1 || idx >= movesWithAnalysis.length) return;
      currentMoveIndex = idx;
      game.reset();
      for (var i = 0; i <= idx; i++) game.move(movesWithAnalysis[i].san);
      board.position(game.fen());
      $('.move-item').removeClass('highlight');
      if (idx >= 0) $('.move-item[data-move-index="' + idx + '"]').addClass('highlight');
      $('#prev-btn').prop('disabled', idx < 0);
      $('#next-btn').prop('disabled', idx >= movesWithAnalysis.length - 1);
    }

    $('#next-btn').on('click', function(){ goToMove(currentMoveIndex + 1); });
    $('#prev-btn').on('click', function(){ goToMove(currentMoveIndex - 1); });
    $('#flip-btn').on('click', function(){ if (board) board.flip(); });
    $('#start-new-btn').on('click', function(){ location.reload(); });
    $(document).on('keydown', function(e){
      if (!$('#review-section').is(':visible')) return;
      if (e.key === 'ArrowRight') goToMove(currentMoveIndex + 1);
      if (e.key === 'ArrowLeft') goToMove(currentMoveIndex - 1);
    });
  });
</script>
</body>
</html>