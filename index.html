<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Move Reviewer</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css"
        crossorigin="anonymous">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom styles for the application */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }

        /* Chessboard.js aspect ratio fix */
        .chessboard-container {
            width: 100%;
            margin: 0 auto;
            aspect-ratio: 1 / 1;
        }

        /* Styling for the move list */
        .move-item {
            transition: background-color: 0.2s ease-in-out;
            border-radius: 0.5rem;
        }
        .move-item.highlight {
            background-color: #384a6e; /* A distinct highlight color */
        }
        .move-item:hover {
            background-color: #2c3a57;
        }

        /* Custom scrollbar for move list */
        #move-analysis-container::-webkit-scrollbar {
            width: 8px;
        }
        #move-analysis-container::-webkit-scrollbar-track {
            background: #2a2a2a;
        }
        #move-analysis-container::-webkit-scrollbar-thumb {
            background-color: #4a4a4a;
            border-radius: 10px;
            border: 2px solid #2a2a2a;
        }

        /* Custom styles for buttons and textareas */
        .btn-primary {
            background-color: #4a90e2;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #357abd;
        }
        .btn-secondary {
            background-color: #4a4a4a;
            transition: background-color: 0.3s;
        }
        .btn-secondary:hover {
            background-color: #5a5a5a;
        }
        textarea.form-input {
            background-color: #252526;
            border-color: #4a4a4a;
        }
        textarea.form-input:focus {
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.5);
            outline: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4 md:p-6">

    <header class="text-center mb-6">
        <h1 class="text-3xl md:text-4xl font-bold text-white">Chess Move Reviewer</h1>
        <p class="text-gray-400 mt-2">Pair your PGN and analysis with an interactive board.</p>
    </header>

    <div id="input-section" class="max-w-6xl w-full mx-auto flex flex-col gap-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="pgn-input" class="block mb-2 font-semibold text-gray-300">1. Paste PGN here</label>
                <textarea id="pgn-input" rows="12" class="w-full p-3 rounded-lg form-input" placeholder="[Event &quot;...&quot;]..."></textarea>
            </div>
            <div>
                <label for="analysis-input" class="block mb-2 font-semibold text-gray-300">2. Paste Formatted Analysis here</label>
                <textarea id="analysis-input" rows="12" class="w-full p-3 rounded-lg form-input" placeholder="e4 – book: A principled first move..."></textarea>
            </div>
        </div>
        <button id="load-game-btn" class="w-full md:w-1/3 mx-auto py-3 px-6 text-lg font-semibold text-white rounded-lg btn-primary">
            Generate Review
        </button>
    </div>

    <main id="review-section" class="hidden flex-1 max-w-7xl w-full mx-auto grid grid-cols-1 lg:grid-cols-5 gap-6">
        <div class="lg:col-span-2 flex flex-col items-center">
            <div class="w-full max-w-md mx-auto"> <div id="board" class="chessboard-container"></div>
            </div>
            <div id="controls" class="mt-4 flex flex-wrap items-center justify-center gap-2 w-full">
                 <button id="reset-btn" class="px-4 py-2 text-white font-semibold rounded-lg btn-secondary">Start</button>
                <button id="prev-btn" class="px-4 py-2 text-white font-semibold rounded-lg btn-secondary">‹ Prev</button>
                <button id="next-btn" class="px-4 py-2 text-white font-semibold rounded-lg btn-secondary">Next ›</button>
                <button id="end-btn" class="px-4 py-2 text-white font-semibold rounded-lg btn-secondary">End</button>
                <button id="flip-btn" class="px-4 py-2 text-white font-semibold rounded-lg btn-secondary">Flip</button>
            </div>
            <button id="new-game-btn" class="mt-4 w-full max-w-xs py-2 px-4 text-white font-semibold rounded-lg btn-primary">
                Load New Game
            </button>
        </div>

        <div class="lg:col-span-3 bg-[#252526] p-4 rounded-lg flex flex-col lg:max-h-[calc(100vh-5rem)]">
            <h2 class="text-xl font-bold border-b border-gray-600 pb-2 mb-3 flex-shrink-0">Game Analysis</h2>
            <div id="move-analysis-container" class="overflow-y-auto flex-1 pr-2 space-y-1">
                </div>
        </div>
    </main>

    <div id="error-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
        <div class="bg-[#2d2d2d] p-8 rounded-lg shadow-xl max-w-sm w-full text-center">
            <h3 class="text-2xl font-bold text-red-400 mb-4">Error</h3>
            <p id="error-message" class="text-gray-300 mb-6">Could not process the input.</p>
            <button id="close-modal-btn" class="py-2 px-6 font-semibold text-white rounded-lg btn-primary">Close</button>
        </div>
    </div>


    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>

    <script>
        $(document).ready(function () {
            let board = null;
            let game = new Chess();
            let movesWithAnalysis = [];
            let currentMoveIndex = -1;

            const classificationStyles = {
                'book': 'text-blue-400',
                'good': 'text-green-400',
                'great': 'text-teal-400',
                'brilliant': 'text-cyan-300',
                'inaccuracy': 'text-yellow-400',
                'mistake': 'text-orange-400',
                'blunder': 'text-red-500',
                'default': 'text-gray-400'
            };

            function getStyleForClassification(classification) {
                const key = classification.toLowerCase().replace(' ', '');
                return classificationStyles[key] || classificationStyles['default'];
            }
            
            function formatText(text) {
                if (!text) return '';
                return text.toString().replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            }

            function showError(message) {
                $('#error-message').text(message);
                $('#error-modal').removeClass('hidden');
            }

            $('#close-modal-btn').on('click', () => {
                $('#error-modal').addClass('hidden');
            });

            function sanitizePgn(pgnString) {
                const parts = pgnString.split('\n\n');
                if (parts.length < 2) {
                    return pgnString;
                }
                const headers = parts[0];
                const movetext = parts.slice(1).join('\n\n');
                const cleanedMovetext = movetext.replace(/(\r\n|\n|\r)/gm, " ").replace(/\s+/g, ' ');
                return headers + '\n\n' + cleanedMovetext;
            }

            $('#load-game-btn').on('click', function () {
                const rawPgn = $('#pgn-input').val().trim();
                const analysisText = $('#analysis-input').val().trim();

                if (!rawPgn || !analysisText) {
                    showError("Please provide both a PGN and analysis text.");
                    return;
                }

                const pgn = sanitizePgn(rawPgn);

                if (!game.load_pgn(pgn)) {
                    showError("Invalid PGN. Please check the PGN format.");
                    return;
                }

                const gameMoves = game.history({ verbose: true });
                const parsedAnalysis = parseAnalysis(analysisText);

                let analysisCursor = 0;
                movesWithAnalysis = gameMoves.map(move => {
                    let moveAnalysis = null;
                    let criticalMoment = null;

                    if (analysisCursor < parsedAnalysis.moves.length && parsedAnalysis.moves[analysisCursor].san === move.san) {
                        moveAnalysis = parsedAnalysis.moves[analysisCursor];
                        analysisCursor++;
                    }

                    if (parsedAnalysis.criticalMoments[move.san]) {
                        criticalMoment = parsedAnalysis.criticalMoments[move.san];
                    }

                    return {
                        ...move,
                        analysis: moveAnalysis,
                        criticalMoment: criticalMoment
                    };
                });
                
                if (!board) {
                    board = Chessboard('board', {
                        position: 'start',
                        draggable: false,
                        pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
                    });
                     $(window).on('resize', () => board.resize());
                }

                $('#input-section').addClass('hidden');
                $('#review-section').removeClass('hidden').addClass('grid');
                board.resize();
                
                renderMoveList();
                renderSummary(parsedAnalysis.summaries);
                goToMove(-1);
            });
            
            function parseAnalysis(text) {
                const lines = text.split('\n');
                const parsedMoves = [];
                const criticalMoments = {};
                const summaries = {};
                let currentSummary = null;
                let lastSan = null;

                const moveRegex = /^(?:\d+\.{1,3}\s*)?([^\s–-—]+)\s*[–-—]\s*(?:\*\*)?([^:]+?)(?:\*\*)?:\s*(.*)/;
                const criticalMomentRegex = /^Critical Moment:\s*(.*)/i;
                const summaryHeaderRegex = /^\s*\*\*(Strengths|Recurring Mistakes|Top 3 Takeaways)\*\*/i;

                lines.forEach(line => {
                    const moveMatch = line.match(moveRegex);
                    const criticalMomentMatch = line.match(criticalMomentRegex);
                    const summaryHeaderRegex = line.match(summaryHeaderRegex);

                    if (moveMatch) {
                        const san = moveMatch[1];
                        const classification = moveMatch[2].trim();
                        const analysisText = moveMatch[3].trim();
                        parsedMoves.push({ san, classification, text: analysisText });
                        lastSan = san;
                    } else if (criticalMomentMatch) {
                        if (lastSan) {
                             criticalMoments[lastSan] = criticalMomentMatch[1];
                        }
                    } else if (summaryHeaderRegex) {
                        currentSummary = summaryHeaderRegex[1].replace(/\s/g, '');
                        summaries[currentSummary] = [];
                    } else if (line.trim() !== '' && line.trim() !== '---' && currentSummary) {
                        summaries[currentSummary].push(line.trim());
                    }
                });

                return { moves: parsedMoves, criticalMoments, summaries };
            }

            function renderMoveList() {
                const container = $('#move-analysis-container');
                container.empty();
                
                movesWithAnalysis.forEach((move, index) => {
                    const moveNumber = Math.floor(index / 2) + 1;
                    const moveNumberDisplay = move.color === 'w' ? `${moveNumber}.` : '';

                    const moveHtml = `
                        <div class="move-item p-2 cursor-pointer" data-move-index="${index}">
                            <div class="flex items-baseline gap-3">
                                <span class="text-gray-500 font-mono w-8 text-right">${moveNumberDisplay}</span>
                                <span class="font-bold text-lg text-white">${move.san}</span>
                                ${move.analysis ? `<span class="font-semibold text-sm ${getStyleForClassification(move.analysis.classification)}">${move.analysis.classification}</span>` : ''}
                            </div>
                            ${move.analysis ? `<p class="pl-12 text-gray-300 text-sm">${formatText(move.analysis.text)}</p>` : ''}
                            ${move.criticalMoment ? `<p class="pl-12 mt-1 text-sm text-yellow-300 bg-yellow-900 bg-opacity-40 p-2 rounded">${formatText(`**Critical Moment:** ${move.criticalMoment}`)}</p>` : ''}
                        </div>
                    `;
                    container.append(moveHtml);
                });
                
                $('.move-item').on('click', function() {
                    const index = $(this).data('move-index');
                    goToMove(index);
                });
            }

            function renderSummary(summaries) {
                const container = $('#move-analysis-container');
                const summaryContent = [];

                const summaryOrder = ['Strengths', 'RecurringMistakes', 'Top3Takeaways'];
                const summaryTitles = {
                    'Strengths': 'Strengths',
                    'RecurringMistakes': 'Recurring Mistakes',
                    'Top3Takeaways': 'Top 3 Takeaways'
                };

                summaryOrder.forEach(key => {
                    if (summaries[key] && summaries[key].length > 0) {
                        const title = summaryTitles[key];
                        const items = summaries[key];
                        
                        let summaryHtml = `<h3 class="text-lg font-semibold mt-2 mb-1 text-gray-200">${title}</h3>`;
                        summaryHtml += '<ul class="list-disc list-inside space-y-1 text-sm text-gray-300">';
                        items.forEach(item => {
                            let cleanedItem = item.trim().replace(/^(\*|-|\d+\.)\s*/, '');
                            summaryHtml += `<li>${formatText(cleanedItem)}</li>`;
                        });
                        summaryHtml += '</ul>';
                        summaryContent.push(summaryHtml);
                    }
                });

                if (summaryContent.length > 0) {
                    container.append(`
                        <div class="mt-4 border-t border-gray-600 pt-3">
                            ${summaryContent.join('')}
                        </div>
                    `);
                }
            }

            function goToMove(index) {
                if (index < -1 || index >= movesWithAnalysis.length) return;

                currentMoveIndex = index;
                
                game.reset();
                for (let i = 0; i <= currentMoveIndex; i++) {
                    game.move(movesWithAnalysis[i].san);
                }

                board.position(game.fen());
                
                $('.move-item').removeClass('highlight');
                if (currentMoveIndex >= 0) {
                    const target = $(`.move-item[data-move-index="${currentMoveIndex}"]`);
                    target.addClass('highlight');
                    
                    // Smoothly scroll the highlighted move to the top of the container
                    const container = $('#move-analysis-container');
                    // Calculate the exact scroll position to bring the element's top to the container's top
                    const newScrollTop = container.scrollTop() + target.position().top;
                    container.animate({
                        scrollTop: newScrollTop
                    }, 250); // 250ms for a smooth scroll animation
                }

                $('#prev-btn').prop('disabled', currentMoveIndex < 0);
                $('#next-btn').prop('disabled', currentMoveIndex >= movesWithAnalysis.length - 1);
                $('#reset-btn').prop('disabled', currentMoveIndex < 0);
                $('#end-btn').prop('disabled', currentMoveIndex >= movesWithAnalysis.length - 1);
            }

            $('#next-btn').on('click', () => goToMove(currentMoveIndex + 1));
            $('#prev-btn').on('click', () => goToMove(currentMoveIndex - 1));
            $('#reset-btn').on('click', () => goToMove(-1));
            $('#end-btn').on('click', () => goToMove(movesWithAnalysis.length - 1));
            
            $('#flip-btn').on('click', () => {
                if(board) {
                    board.flip();
                }
            });

            $('#new-game-btn').on('click', () => {
                $('#review-section').addClass('hidden').removeClass('grid');
                $('#input-section').removeClass('hidden');
            });
            
            $(document).on('keydown', function(e) {
                if ($('#review-section').is(':visible')) {
                    if (e.key === 'ArrowRight') {
                        goToMove(currentMoveIndex + 1);
                    } else if (e.key === 'ArrowLeft') {
                        goToMove(currentMoveIndex - 1);
                    }
                }
            });
        });
    </script>

</body>
</html>
